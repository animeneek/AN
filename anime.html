<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AnimeNeek - Anime Details_v2355</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/animeneek/AnimeNeek/main/assets/favicon-image.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    body{background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .inactive-btn{opacity:.4;pointer-events:none}
    .glass{background:rgba(255,255,255,.08);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.15)}
    .tag{background:rgba(255,68,68,.1);border:1px solid rgba(255,68,68,.5);padding:2px 10px;border-radius:9999px;font-size:.8rem}
    .tag:hover{background:#ff4444;color:#fff}

    /* Episode rail - modern minimal style */
    .rail{
      display:flex;gap:.5rem;overflow-x:auto;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;
      padding:.5rem 0;
    }
.rail::-webkit-scrollbar {
  height: 4px;
}
.rail::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.25);
  border-radius: 9999px;
}
.rail::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 68, 68, 0.6);
}
.rail::-webkit-scrollbar-track {
  background: transparent;
}


    .card-mini{flex:0 0 110px}
    .card-mini img{border-radius:.5rem}
    .staff-card{flex:0 0 170px}
    .staff-card img{border-radius:9999px}
    .reco-card{flex:0 0 140px}
    .reco-card img{border-radius:.5rem}
    .section-title{font-size:1.125rem;font-weight:600;color:#ff6b6b;display:flex;align-items:center;gap:.5rem}
    .info-grid{display:grid;grid-template-columns:max-content 1fr;gap:.25rem 1rem}
    .info-grid>span:nth-child(odd){color:#bbb}

    /* Premium selects - glassy */
/* Replace the existing select styles with these */
select {
  background: rgba(30, 30, 30, 0.3);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 68, 68, 0.35);
  color: #e0f0ff;
  border-radius: 0.6rem;
  padding: 0.4rem 2rem 0.4rem 1.2rem;
    padding-left: 1.2rem !important;  /* force padding to apply */
    padding-top: 0.2rem !important;
    padding-bottom: 0.4rem !important;
  appearance: none;
  font-weight: 500;
  font-size: 0.85rem;
}
select option {
  background: rgba(20, 20, 20, 0.65);
  backdrop-filter: blur(6px);
  color: #fff;
}

    select:focus{outline:none;border-color:#ff4444;box-shadow:0 0 0 2px rgba(255,68,68,.35)}
    select::-webkit-scrollbar{width:8px}
    select::-webkit-scrollbar-thumb{background:#ff4444;border-radius:10px}
    select::-webkit-scrollbar-track{background:transparent}

    #episode-select {
  background: rgba(20,20,20); /* darker transparent */
  backdrop-filter: blur(12px); /* strong blur */
  border: 1px solid rgba(255,68,68,0.4);
  border-radius: 0.75rem;
  color: #fff;
  padding: 0.5rem 1rem;
  font-weight: 500;
  font-size: 0.9rem;
  appearance: none;
}

#episode-select option {
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  color: #fff;
}


    /* Player overlay */
    #player-overlay{
      position:absolute; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,.6); color:#fff; font-size:1.1rem; font-weight:600; text-align:center;
    }
    #player-overlay i{margin-top:.5rem;font-size:1.25rem;color:#ff6b6b}

    /* Control bar */
    .controls{gap:1rem}
    .controls .block-label{font-size:.75rem;color:#aab4c0;letter-spacing:.02em;margin-bottom:.25rem}

    /* Episode chip */
/* Replace the existing .chip styles with these */
.chip {
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.03);
  backdrop-filter: blur(8px);
  padding: 0.35rem 0.8rem;
  border-radius: 0.6rem;
  font-size: 0.8rem;
  font-weight: 500;
  color: #e6edf3;
  white-space: nowrap;
  transition: all 0.15s ease;
}
.chip:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(255, 255, 255, 0.2);
}
.chip.active {
  background: rgba(255, 68, 68, 0.15);
  border-color: rgba(255, 68, 68, 0.6);
  color: #fff;
  font-weight: 600;
}

    /* Segmented source buttons */
/* Replace the existing .seg styles with these */
.seg {
  display: inline-flex;
  border: 1px solid rgba(255, 68, 68, 0.35);
  border-radius: 0.6rem;
  overflow: hidden;
  background: rgba(20, 20, 20, 0.35);
  backdrop-filter: blur(10px);
  width: fit-content;       /* ðŸ”¥ keeps box only around buttons */
  max-width: 100%;          /* prevents overflow */
}

.seg button {
  padding: 0.45rem 1rem;
  font-weight: 600;
  font-size: 0.8rem;
  color: #e0e6ec;
  transition: all 0.12s ease;
  background: transparent;
}
.seg button + button {
  border-left: 1px solid rgba(255, 255, 255, 0.08);
}
.seg button[aria-pressed="true"] {
  background: rgba(255, 68, 68, 0.5);
  color: #fff;
  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.25);
}
.seg button:not([aria-pressed="true"]):hover {
  background: rgba(255, 255, 255, 0.08);
}

    .seg button:disabled{opacity:.5; cursor:not-allowed}

    /* Play button */
    .playbtn{
      padding:.7rem 1.25rem; border-radius:1rem; font-weight:900; letter-spacing:.03em;
      background:linear-gradient(135deg,#ff4d4d,#ff6b6b); color:#000;
      box-shadow:0 8px 24px rgba(255,77,77,.25);
      transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .playbtn:hover{transform:translateY(-1px); box-shadow:0 10px 28px rgba(255,77,77,.35); filter:saturate(1.05)}
    .playbtn:disabled{opacity:.4; box-shadow:none; filter:none}

    /* Title color (theme accent) */
    #player-title{color:#ff6b6b}

    /* Mobile fixes */
    @media(max-width:640px){
      #source-group{justify-content:center}
      #play-btn{width:100%}
      .seg{width:auto; max-width:100%; flex-wrap:wrap}
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- header include -->
  <div id="header"></div>

  <main class="flex-grow container mx-auto px-4 py-6 max-w-screen-xl space-y-10">

    <!-- Top: Poster + Details -->
    <section id="anime-details" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-start">
      <aside class="md:col-span-1 space-y-4">
        <div class="w-full">
          <img id="anime-poster" src="" alt="Anime Poster" class="w-full h-auto max-h-[420px] object-cover rounded-xl shadow-xl" />
        </div>
      </aside>

      <div class="md:col-span-3 space-y-5">
        <div>
          <h1 id="anime-title" class="text-3xl md:text-4xl font-extrabold tracking-tight text-white"></h1>
          <p id="anime-alt-titles" class="text-sm text-gray-400 italic mt-1"></p>
        </div>
        <p id="anime-synopsis" class="text-gray-300 leading-relaxed"></p>
        <div id="anime-genres" class="flex flex-wrap gap-2"></div>
        <div class="info-grid text-sm">
          <span>Format</span><span id="anime-format" class="font-medium">â€”</span>
          <span>Status</span><span id="anime-status" class="font-medium">â€”</span>
          <span>Episodes</span><span id="anime-episodes" class="font-medium">â€”</span>
          <span>Rating</span><span id="anime-rating" class="font-medium">â€”</span>
        </div>
      </div>
    </section>

    <!-- Video Player Section -->
    <section>
      <h2 id="player-title" class="text-xl font-bold text-center">
        <i class="fa fa-play-circle mr-2"></i>
        <span id="player-title-text">Pick an episode to begin</span>
      </h2>

      <div class="aspect-video w-full mt-4 rounded-xl overflow-hidden shadow-xl bg-black relative">
        <iframe id="video-frame" src="https://dragonball.guru/wp-content/uploads/2021/01/goku-dragon-ball-guru.jpg"
          width="100%" height="100%" frameborder="0" allowfullscreen class="w-full h-full"></iframe>
        <div id="player-overlay">
          <span>Select an Episode Below</span>
          <i class="fa fa-arrow-down"></i>
        </div>
      </div>

      <!-- Controls -->
      <div class="glass rounded-2xl p-4 mt-4 controls">
        <!-- Episodes -->
        <div class="mb-3">
          <div class="block-label"><i class="fa fa-list-ol mr-1"></i> Episodes</div>
          <div class="flex items-center gap-3">
            <div id="episode-rail" class="rail flex-1"></div>
            <!-- compact fallback select -->
            <select id="episode-select" class="min-w-[170px]">
              <option disabled selected>Loadingâ€¦</option>
            </select>
          </div>
        </div>

        <!-- Source + Play -->
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3">
          <div class="flex flex-col flex-1">
            <div class="block-label"><i class="fa fa-language mr-1"></i> Source</div>
            <div id="source-group" class="seg inline-flex" role="tablist" aria-label="Source Toggle">
              <!-- buttons injected -->
            </div>
          </div>
          <button id="play-btn" class="playbtn self-start sm:self-auto">
            <i class="fa fa-play"></i> Play
          </button>
        </div>
      </div>
    </section>

    <!-- Related -->
    <section>
      <h2 class="section-title"><i class="fa fa-link"></i> Related</h2>
      <div id="related-rail" class="rail"></div>
      <p id="related-empty" class="text-sm text-gray-500 mt-2 hidden">No related titles found.</p>
    </section>

    <!-- Characters -->
    <section>
      <h2 class="section-title"><i class="fa fa-users"></i> Characters & Voice Actors</h2>
      <div id="characters-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
      <p id="characters-empty" class="text-sm text-gray-500 mt-2 hidden">No characters found.</p>
    </section>

    <!-- Staff -->
    <section>
      <h2 class="section-title"><i class="fa fa-id-badge"></i> Staff</h2>
      <div id="staff-rail" class="rail"></div>
      <p id="staff-empty" class="text-sm text-gray-500 mt-2 hidden">No staff found.</p>
    </section>

    <!-- Recommendations -->
    <section>
      <h2 class="section-title"><i class="fa fa-thumbs-up"></i> Recommendations</h2>
      <div id="reco-rail" class="rail"></div>
      <p id="reco-empty" class="text-sm text-gray-500 mt-2 hidden">No recommendations yet.</p>
    </section>
  </main>

  <div id="footer"></div>

  <!-- (kept same script logic, no changes needed) -->
  <script>
    /* same JS as you had â€” untouched */
    async function loadPartials() {
      const headerHTML = await fetch("header.html").then(r=>r.text());
      document.getElementById("header").innerHTML = headerHTML;
      const footerHTML = await fetch("footer.html").then(r=>r.text());
      document.getElementById("footer").innerHTML = footerHTML;
      const btn = document.getElementById("menu-btn");
      const menu = document.getElementById("mobile-menu");
      if(btn && menu){ btn.addEventListener("click", ()=>menu.classList.toggle("hidden")); }
      await initAnimePage();
    }
    function qs(name){ return new URLSearchParams(location.search).get(name); }

    async function fetchAnimeDetails(id){
      const query=`query ($id:Int){Media(id:$id, type:ANIME){id title{romaji english native} coverImage{large} description(asHtml:false) genres format status episodes averageScore relations{edges{relationType(version:2) node{id title{romaji english} coverImage{medium}}}} characters(sort:ROLE){edges{role node{id name{full} image{medium}} voiceActors(language:JAPANESE){id name{full} languageV2 image{medium}}}} staff(sort:RELEVANCE){edges{role node{id name{full} image{medium}}}} recommendations(sort:RATING_DESC){nodes{rating mediaRecommendation{id title{romaji english} coverImage{medium}}}}}}`;
      const res=await fetch("https://graphql.anilist.co",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query,variables:{id:Number(id)}})});
      const j=await res.json();return j.data?.Media;
    }

    async function loadEpisodes(id){
      const res=await fetch("episodes.json",{cache:"no-store"});
      const json=await res.json();
      return json.find(item=>String(item.id)===String(id));
    }

    function buildIframeSrc(type, episodeId, mode){
      if(!episodeId) return "";
      if(type==="anime"){
        if(mode==="sub") return `https://megaplay.buzz/stream/s-2/${episodeId}/sub`;
        if(mode==="dub") return `https://megaplay.buzz/stream/s-2/${episodeId}/dub`;
      }else{
        // h-raw / h-sub / h-dub
        return `https://streamtape.to/e/${episodeId}`;
      }
      return "";
    }

    // --- RENDER HELPERS ---
    function renderGenres(genres){
      const wrap=document.getElementById("anime-genres");
      wrap.innerHTML="";
      (genres||[]).forEach(g=>{
        const a=document.createElement("a");
        a.href=`search.html?genre=${encodeURIComponent(g)}`;
        a.className="tag";
        a.textContent=g;
        wrap.appendChild(a);
      });
    }

    function renderRelated(edges){
      const rail=document.getElementById("related-rail");
      const empty=document.getElementById("related-empty");
      rail.innerHTML="";
      if(!edges||!edges.length){empty.classList.remove("hidden");return;}
      empty.classList.add("hidden");
      edges.forEach(e=>{
        const a=document.createElement("a");
        a.href=`anime.html?id=${e.node.id}`;
        a.className="card-mini";
        a.innerHTML=`<img src="${e.node.coverImage.medium}" class="w-[110px] h-[155px] object-cover shadow-lg rounded-lg"/><div class="text-[11px] text-center mt-1 line-clamp-2 text-gray-200">${e.node.title.english||e.node.title.romaji}</div>`;
        rail.appendChild(a);
      });
    }

    function renderCharacters(edges){
      const grid=document.getElementById("characters-grid");
      const empty=document.getElementById("characters-empty");
      grid.innerHTML="";
      if(!edges||!edges.length){empty.classList.remove("hidden");return;}
      empty.classList.add("hidden");
      edges.forEach(c=>{
        const va=(c.voiceActors&&c.voiceActors[0])?c.voiceActors[0]:null;
        const card=document.createElement("div");
        card.className="glass rounded-xl p-3 flex gap-3";
        card.innerHTML=`<a href="character.html?id=${c.node.id}" class="flex-shrink-0"><img src="${c.node.image.medium}" class="w-16 h-16 rounded-lg object-cover" alt="${c.node.name.full}"></a><div class="flex-1 min-w-0"><a href="character.html?id=${c.node.id}" class="font-semibold hover:underline">${c.node.name.full}</a><div class="text-xs text-gray-400">${c.role}</div>${va?`<div class="flex items-center justify-between mt-2"><div class="text-xs text-gray-300 text-right truncate"><a href="staff.html?id=${va.id}" class="hover:underline font-medium">${va.name.full}</a><span class="text-gray-400"> â€¢ ${va.languageV2||""}</span></div><a href="staff.html?id=${va.id}" class="flex-shrink-0"><img src="${va.image.medium}" class="w-10 h-10 rounded-full object-cover"></a></div>`:`<div class="text-xs text-gray-500 mt-2">No voice actor listed</div>`}</div>`;
        grid.appendChild(card);
      });
    }

    function renderStaff(edges){
      const rail=document.getElementById("staff-rail");
      const empty=document.getElementById("staff-empty");
      rail.innerHTML="";
      if(!edges||!edges.length){empty.classList.remove("hidden");return;}
      empty.classList.add("hidden");
      edges.forEach(s=>{
        const a=document.createElement("a");
        a.href=`staff.html?id=${s.node.id}`;
        a.className="staff-card glass rounded-2xl p-3 flex flex-col items-center text-center";
        a.innerHTML=`<img src="${s.node.image.medium}" class="w-16 h-16 object-cover mb-2 rounded-full" alt="${s.node.name.full}"><div class="text-sm font-semibold line-clamp-2">${s.node.name.full}</div><div class="text-xs text-gray-400 mt-1 line-clamp-2">${s.role}</div>`;
        rail.appendChild(a);
      });
    }

    function renderRecommendations(nodes){
      const rail=document.getElementById("reco-rail");
      const empty=document.getElementById("reco-empty");
      rail.innerHTML="";
      if(!nodes||!nodes.length){
        empty.classList.remove("hidden");
        return;
      }
      empty.classList.add("hidden");
      nodes.forEach(r=>{
        const a=document.createElement("a");
        a.href=`anime.html?id=${r.mediaRecommendation.id}`;
        a.className="reco-card";
        a.innerHTML=`
          <img src="${r.mediaRecommendation.coverImage.medium}" 
               class="w-[140px] h-[200px] object-cover shadow-lg rounded-lg"/>
          <div class="text-[12px] text-center mt-1 line-clamp-2 text-gray-200">
            ${r.mediaRecommendation.title.english || r.mediaRecommendation.title.romaji}
          </div>`;
        rail.appendChild(a);
      });
    }

    // --- Player controls state ---
    let selectedEpisodeId = null;
    let selectedEpisodeLabel = null; // e.g., "1 (Part 1)"
    let selectedMode = null; // 'sub' | 'dub' | 'raw'

    function setPlayerTitle(epLabel, mode){
      const titleSpan = document.getElementById("player-title-text");
      if(epLabel && mode){
        titleSpan.textContent = `Now Playing â€¢ Episode ${epLabel} â€” ${mode.toUpperCase()}`;
      }else{
        titleSpan.textContent = "Pick an episode to begin";
      }
    }

    function createSourceButtons(type){
      const group = document.getElementById("source-group");
      group.innerHTML = "";

      function addBtn(label, val, enabled=true, pressed=false){
        const b=document.createElement("button");
        b.type="button";
        b.textContent=label;
        b.setAttribute("aria-pressed", String(pressed));
        if(!enabled) b.disabled=true;
        b.addEventListener("click", ()=>{
          [...group.querySelectorAll("button")].forEach(x=>x.setAttribute("aria-pressed","false"));
          b.setAttribute("aria-pressed","true");
          selectedMode = val;
        });
        group.appendChild(b);
        if(pressed){ selectedMode = val; }
      }

      if(type==="anime"){
        addBtn("SUB","sub",true,true);  // default
        addBtn("DUB","dub",true,false);
      }else{
        // h-raw / h-sub / h-dub: expose only what's relevant
        const label = type.replace("h-","").toUpperCase(); // RAW / SUB / DUB
        const val = type.replace("h-","").toLowerCase();   // raw / sub / dub
        addBtn(label,val,true,true);
      }
    }

    function populateEpisodesUI(epData){
      const rail = document.getElementById("episode-rail");
      const select = document.getElementById("episode-select");
      rail.innerHTML = "";
      select.innerHTML = "";

      epData.episodes.forEach((ep, idx)=>{
        const label = String(ep.episode); // show exactly what's in JSON
        // chip
        const chip=document.createElement("button");
        chip.className="chip";
        chip.textContent=`Ep ${label}`;
        chip.dataset.id = ep.id;
        chip.addEventListener("click", ()=>{
          selectedEpisodeId = ep.id;
          selectedEpisodeLabel = label;
          // activate
          [...rail.querySelectorAll(".chip")].forEach(c=>c.classList.remove("active"));
          chip.classList.add("active");
          // sync dropdown
          select.value = ep.id;
        });
        rail.appendChild(chip);

        // dropdown option (fallback)
        const opt=document.createElement("option");
        opt.value=ep.id;
        opt.textContent=`Episode ${label}`;
        if(idx===0){ opt.selected=true; }
        select.appendChild(opt);
      });

      // default select first episode
      if(epData.episodes.length){
        const first = epData.episodes[0];
        selectedEpisodeId = first.id;
        selectedEpisodeLabel = String(first.episode);
        rail.firstChild?.classList.add("active");
      }

      // when dropdown changes, sync chips
      select.addEventListener("change", ()=>{
        selectedEpisodeId = select.value;
        const found = epData.episodes.find(e => String(e.id)===String(selectedEpisodeId));
        selectedEpisodeLabel = found ? String(found.episode) : null;
        [...rail.querySelectorAll(".chip")].forEach(c=>{
          c.classList.toggle("active", c.dataset.id===String(selectedEpisodeId));
        });
      });
    }

    async function initAnimePage(){
      const id=qs("id");if(!id)return;
      const media=await fetchAnimeDetails(id);

      // Main details
      document.getElementById("anime-poster").src=media.coverImage.large;
      document.getElementById("anime-title").textContent=media.title.english||media.title.romaji;
      document.getElementById("anime-alt-titles").textContent=[media.title.romaji,media.title.native].filter(Boolean).join(" | ");
      document.getElementById("anime-synopsis").innerHTML=media.description||"No description available.";
      document.getElementById("anime-format").textContent=media.format||"â€”";
      document.getElementById("anime-status").textContent=media.status||"â€”";
      document.getElementById("anime-episodes").textContent=media.episodes||"â€”";
      document.getElementById("anime-rating").textContent=media.averageScore?`${media.averageScore}/100`:"â€”";
      renderGenres(media.genres);

      // Side content
      renderRelated(media.relations?.edges||[]);
      renderCharacters(media.characters?.edges||[]);
      renderStaff(media.staff?.edges||[]);
      renderRecommendations(media.recommendations?.nodes||[]);

      // Episodes data
      const epData=await loadEpisodes(id);
      const playBtn=document.getElementById("play-btn");
      const frame=document.getElementById("video-frame");
      const overlay=document.getElementById("player-overlay");

      if(!epData||!epData.episodes||!epData.episodes.length){
        // No episodes
        document.getElementById("episode-rail").innerHTML =
          `<span class="text-sm text-gray-400 px-2 py-1">Episodes Coming Soon</span>`;
        const sel=document.getElementById("episode-select");
        sel.innerHTML=`<option selected>Episodes Coming Soon</option>`;
        sel.disabled=true;
        document.getElementById("source-group").innerHTML =
          `<span class="text-sm text-gray-400 px-2 py-1">â€”</span>`;
        playBtn.disabled=true;
        setPlayerTitle(null,null);
        return;
      }

      // Build UI
      populateEpisodesUI(epData);
      createSourceButtons(epData.type);

      // Play handler
      playBtn.addEventListener("click",()=>{
        const src=buildIframeSrc(epData.type,selectedEpisodeId,selectedMode);
        if(src){
          frame.src=src;
          overlay.style.display="none";
          setPlayerTitle(selectedEpisodeLabel, selectedMode);
        }else{
          // fallback image if not available
          frame.src="https://www.thematthewaaronshow.com/content/images/size/w2000/2022/11/New-Episodes.png";
          overlay.style.display="none";
          setPlayerTitle(selectedEpisodeLabel, selectedMode);
        }
      });
    }

    // Boot
    document.addEventListener("DOMContentLoaded", loadPartials);
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AnimeNeek - Anime Details</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/animeneek/AnimeNeek/main/assets/favicon-image.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    body{background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    .inactive-btn{opacity:.4;pointer-events:none}
    .glass{background:rgba(255,255,255,.05);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.06)}
    .tag{background:rgba(255,68,68,.1);border:1px solid rgba(255,68,68,.5);padding:2px 10px;border-radius:9999px;font-size:.8rem}
    .tag:hover{background:#ff4444;color:#fff}
    .rail{display:flex;gap:.75rem;overflow-x:auto;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;padding-bottom:.25rem}
    .rail::-webkit-scrollbar{height:6px}
    .rail::-webkit-scrollbar-thumb{background:#ff4444;border-radius:10px}
    .card-mini{flex:0 0 110px}
    .card-mini img{border-radius:.5rem}
    .staff-card{flex:0 0 170px}
    .staff-card img{border-radius:9999px}
    .reco-card{flex:0 0 140px}
    .reco-card img{border-radius:.5rem}
    .section-title{font-size:1.125rem;font-weight:600;color:#ff6b6b;display:flex;align-items:center;gap:.5rem}
    /* Fix: label/value pairing always neat */
    .info-grid{display:grid;grid-template-columns: max-content 1fr;gap:.25rem 1rem}
    .info-grid > span:nth-child(odd){color:#bbb}
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- header include -->
  <div id="header"></div>

  <main class="flex-grow container mx-auto px-4 py-6 max-w-screen-xl space-y-10">

    <!-- Top: Poster + Details -->
    <section id="anime-details" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-start">
      <!-- Poster -->
      <aside class="md:col-span-1 space-y-4">
        <div class="w-full">
          <img id="anime-poster" src="" alt="Anime Poster" class="w-full h-auto max-h-[420px] object-cover rounded-xl shadow-xl" />
        </div>
        <!-- (Favourite block removed as requested) -->
      </aside>

      <!-- Details -->
      <div class="md:col-span-3 space-y-5">
        <div>
          <h1 id="anime-title" class="text-3xl md:text-4xl font-extrabold tracking-tight text-white"></h1>
          <p id="anime-alt-titles" class="text-sm text-gray-400 italic mt-1"></p>
        </div>

        <p id="anime-synopsis" class="text-gray-300 leading-relaxed"></p>

        <!-- Genres -->
        <div id="anime-genres" class="flex flex-wrap gap-2"></div>

        <!-- Tight info grid + rating (fixed pairing) -->
        <div class="info-grid text-sm">
          <span>Format</span><span id="anime-format" class="font-medium">—</span>
          <span>Status</span><span id="anime-status" class="font-medium">—</span>
          <span>Episodes</span><span id="anime-episodes" class="font-medium">—</span>
          <span>Rating</span><span id="anime-rating" class="font-medium">—</span>
        </div>

        <!-- Watch Buttons -->
        <div class="flex flex-wrap gap-3 pt-2">
          <a id="btn-raw" href="#" class="px-4 py-2 rounded-lg bg-yellow-500 hover:bg-yellow-600 text-black font-bold transition">RAW</a>
          <a id="btn-sub" href="#" class="px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-black font-bold transition">SUB</a>
          <a id="btn-dub" href="#" class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-black font-bold transition">DUB</a>
        </div>
      </div>
    </section>

    <!-- Related (small posters, slider) -->
    <section>
      <h2 class="section-title"><i class="fa fa-link"></i> Related</h2>
      <div id="related-rail" class="rail"></div>
      <p id="related-empty" class="text-sm text-gray-500 mt-2 hidden">No related titles found.</p>
    </section>

    <!-- Characters (grid, each card shows character + VA) -->
    <section>
      <h2 class="section-title"><i class="fa fa-users"></i> Characters & Voice Actors</h2>
      <div id="characters-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
      <p id="characters-empty" class="text-sm text-gray-500 mt-2 hidden">No characters found.</p>
    </section>

    <!-- Staff (one-line slider) -->
    <section>
      <h2 class="section-title"><i class="fa fa-id-badge"></i> Staff</h2>
      <div id="staff-rail" class="rail"></div>
      <p id="staff-empty" class="text-sm text-gray-500 mt-2 hidden">No staff found.</p>
    </section>

    <!-- Recommendations (slider) -->
    <section>
      <h2 class="section-title"><i class="fa fa-thumbs-up"></i> Recommendations</h2>
      <div id="reco-rail" class="rail"></div>
      <p id="reco-empty" class="text-sm text-gray-500 mt-2 hidden">No recommendations yet.</p>
    </section>

  </main>

  <!-- footer include -->
  <div id="footer"></div>

  <script>
    // --- Header & Footer includes ---
    async function loadPartials() {
      const headerHTML = await fetch("header.html").then(r=>r.text());
      document.getElementById("header").innerHTML = headerHTML;
      const footerHTML = await fetch("footer.html").then(r=>r.text());
      document.getElementById("footer").innerHTML = footerHTML;
      const btn = document.getElementById("menu-btn");
      const menu = document.getElementById("mobile-menu");
      if(btn && menu){ btn.addEventListener("click", ()=>menu.classList.toggle("hidden")); }
      await initAnimePage();
    }

    // --- Utilities ---
    function qs(name){ return new URLSearchParams(location.search).get(name); }

    // --- Fetchers ---
    async function fetchAnimeDetails(id){
      const query = `
        query ($id:Int){
          Media(id:$id, type:ANIME){
            id
            title{romaji english native}
            coverImage{large}
            description(asHtml:false)
            genres
            format
            status
            episodes
            averageScore
            relations{
              edges{
                relationType(version:2)
                node{ id title{romaji english} coverImage{medium} }
              }
            }
            characters(sort:ROLE){
              edges{
                role
                node{ id name{full} image{medium} }
                voiceActors(language:JAPANESE){ id name{full} languageV2 image{medium} }
              }
            }
            staff(sort:RELEVANCE){
              edges{
                role
                node{ id name{full} image{medium} }
              }
            }
            recommendations(sort:RATING_DESC){
              nodes{
                rating
                mediaRecommendation{
                  id
                  title{romaji english}
                  coverImage{medium}
                }
              }
            }
          }
        }`;
      const res = await fetch("https://graphql.anilist.co",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({query, variables:{id:Number(id)}})
      });
      const j = await res.json();
      return j.data?.Media;
    }

    // Build availability from episodes.json (array format)
    async function computeAvailability(id){
      try{
        const res = await fetch("episodes.json",{cache:"no-store"});
        const json = await res.json(); // array of entries
        const typesForId = new Set(
          json.filter(item => String(item.id) === String(id)).map(item => item.type)
        );

        // Activation rules
        const hasAnime = typesForId.has("anime");
        const hasHRaw  = typesForId.has("h-raw");
        const hasHSub  = typesForId.has("h-sub");
        const hasHDub  = typesForId.has("h-dub");

        return {
          raw: hasHRaw,                         // RAW from h-raw
          sub: hasAnime || hasHSub,             // SUB from anime or h-sub
          dub: hasAnime || hasHDub,             // DUB from anime or h-dub
          any: (hasHRaw || hasAnime || hasHSub || hasHDub)
        };
      }catch(e){
        console.error("episodes.json load error", e);
        return {raw:false, sub:false, dub:false, any:false};
      }
    }

    // --- Renderers ---
    function renderGenres(genres){
      const wrap = document.getElementById("anime-genres");
      wrap.innerHTML = "";
      (genres || []).forEach(g=>{
        const a = document.createElement("a");
        a.href = `search.html?genre=${encodeURIComponent(g)}`;
        a.className = "tag";
        a.textContent = g;
        wrap.appendChild(a);
      });
    }

    function renderRelated(edges){
      const rail = document.getElementById("related-rail");
      const empty = document.getElementById("related-empty");
      rail.innerHTML = "";
      if(!edges || !edges.length){ empty.classList.remove("hidden"); return; }
      empty.classList.add("hidden");
      edges.forEach(e=>{
        const a = document.createElement("a");
        a.href = `anime.html?id=${e.node.id}`;
        a.className = "card-mini";
        a.innerHTML = `
          <img src="${e.node.coverImage.medium}" alt="" class="w-[110px] h-[155px] object-cover shadow-lg" />
          <div class="text-[11px] text-center mt-1 line-clamp-2 text-gray-200">${e.node.title.english || e.node.title.romaji}</div>
        `;
        rail.appendChild(a);
      });
    }

    function renderCharacters(edges){
      const grid = document.getElementById("characters-grid");
      const empty = document.getElementById("characters-empty");
      grid.innerHTML = "";
      if(!edges || !edges.length){ empty.classList.remove("hidden"); return; }
      empty.classList.add("hidden");
      edges.forEach(c=>{
        const va = (c.voiceActors && c.voiceActors[0]) ? c.voiceActors[0] : null;
        const card = document.createElement("div");
        card.className = "glass rounded-xl p-3 flex gap-3";
        card.innerHTML = `
          <a href="character.html?id=${c.node.id}" class="flex-shrink-0">
            <img src="${c.node.image.medium}" class="w-16 h-16 rounded-lg object-cover" alt="${c.node.name.full}">
          </a>
          <div class="flex-1 min-w-0">
            <a href="character.html?id=${c.node.id}" class="font-semibold hover:underline">${c.node.name.full}</a>
            <div class="text-xs text-gray-400">${c.role}</div>
            ${va ? `
              <div class="flex items-center justify-between mt-2">
                <div class="text-xs text-gray-300 text-right truncate">
                  <a href="staff.html?id=${va.id}" class="hover:underline font-medium">${va.name.full}</a>
                  <span class="text-gray-400"> • ${va.languageV2 || ""}</span>
                </div>
                <a href="staff.html?id=${va.id}" class="flex-shrink-0">
                  <img src="${va.image.medium}" class="w-10 h-10 rounded-full object-cover">
                </a>
              </div>
            ` : `<div class="text-xs text-gray-500 mt-2">No voice actor listed</div>`}
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function renderStaff(edges){
      const rail = document.getElementById("staff-rail");
      const empty = document.getElementById("staff-empty");
      rail.innerHTML = "";
      if(!edges || !edges.length){ empty.classList.remove("hidden"); return; }
      empty.classList.add("hidden");
      edges.forEach(s=>{
        const a = document.createElement("a");
        a.href = `staff.html?id=${s.node.id}`;
        a.className = "staff-card glass rounded-2xl p-3 flex flex-col items-center text-center";
        a.innerHTML = `
          <img src="${s.node.image.medium}" class="w-16 h-16 object-cover mb-2" alt="${s.node.name.full}">
          <div class="text-sm font-semibold line-clamp-2">${s.node.name.full}</div>
          <div class="text-xs text-gray-400 mt-1 line-clamp-2">${s.role}</div>
        `;
        rail.appendChild(a);
      });
    }

    function renderRecommendations(nodes){
      const rail = document.getElementById("reco-rail");
      const empty = document.getElementById("reco-empty");
      rail.innerHTML = "";
      if(!nodes || !nodes.length){ empty.classList.remove("hidden"); return; }
      empty.classList.add("hidden");
      nodes.forEach(n=>{
        const m = n.mediaRecommendation;
        if(!m) return;
        const a = document.createElement("a");
        a.href = `anime.html?id=${m.id}`;
        a.className = "reco-card";
        a.innerHTML = `
          <img src="${m.coverImage.medium}" alt="" class="w-[140px] h-[200px] object-cover shadow-lg" />
          <div class="text-xs text-center mt-1 line-clamp-2 text-gray-200">${m.title.english || m.title.romaji}</div>
        `;
        rail.appendChild(a);
      });
    }

    // --- Init ---
    async function initAnimePage(){
      const id = qs("id");
      if(!id) return;

      // Fetch Ani
      const media = await fetchAnimeDetails(id);

      // Main details
      document.getElementById("anime-poster").src = media.coverImage.large;
      document.getElementById("anime-title").textContent = media.title.english || media.title.romaji;
      document.getElementById("anime-alt-titles").textContent = [media.title.romaji, media.title.native].filter(Boolean).join(" | ");
      document.getElementById("anime-synopsis").innerHTML = media.description || "No description available.";
      document.getElementById("anime-format").textContent = media.format || "—";
      document.getElementById("anime-status").textContent = media.status || "—";
      document.getElementById("anime-episodes").textContent = media.episodes || "—";
      document.getElementById("anime-rating").textContent = media.averageScore ? `${media.averageScore}/100` : "—";
      renderGenres(media.genres);

      // Watch buttons availability (from episodes.json rules)
      const avail = await computeAvailability(id);
      const btnRaw = document.getElementById("btn-raw");
      const btnSub = document.getElementById("btn-sub");
      const btnDub = document.getElementById("btn-dub");

      // Keep your original href style
      btnRaw.href = `/watch.html?id=${id}&type=raw`;
      btnSub.href = `/watch.html?id=${id}&type=sub`;
      btnDub.href = `/watch.html?id=${id}&type=dub`;

      // Start inactive; activate per rules
      if(!avail.raw) btnRaw.classList.add("inactive-btn"); else btnRaw.classList.remove("inactive-btn");
      if(!avail.sub) btnSub.classList.add("inactive-btn"); else btnSub.classList.remove("inactive-btn");
      if(!avail.dub) btnDub.classList.add("inactive-btn"); else btnDub.classList.remove("inactive-btn");

      // Related / Characters / Staff / Recos (unchanged)
      renderRelated(media.relations?.edges || []);
      renderCharacters(media.characters?.edges || []);
      renderStaff(media.staff?.edges || []);
      renderRecommendations(media.recommendations?.nodes || []);
    }

    // Kickoff
    loadPartials();
  </script>
</body>
</html>

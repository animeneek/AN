<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AnimeNeek - Anime Details</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/animeneek/AnimeNeek/main/assets/favicon-image.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .inactive-btn { opacity: 0.4; pointer-events: none; }
    .glass-box { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(8px); border-radius: 12px; padding: 1rem; }
    a.genre-tag { background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.5); padding: 2px 8px; border-radius: 9999px; font-size: 0.85rem; transition: 0.2s; }
    a.genre-tag:hover { background: #ff4444; color: white; }
    .section-title { font-size: 1.25rem; font-weight: 600; color: #ff4444; margin-bottom: 0.5rem; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <div id="header"></div>

  <main class="flex-grow container mx-auto px-4 py-6 max-w-screen-xl">

    <!-- Anime Info -->
    <section id="anime-details" class="flex flex-col md:flex-row gap-6">
      <!-- Poster & User Actions -->
      <div class="flex-shrink-0 w-full md:w-1/3 space-y-4">
        <img id="anime-poster" src="" alt="Anime Poster" class="w-full rounded-lg shadow-lg object-cover" />
        
        <!-- Progress & Favourite -->
        <div class="glass-box space-y-3">
          <div>
            <label class="block text-xs text-gray-400 mb-1">Progress</label>
            <input type="range" id="progress-bar" min="0" max="12" value="0" class="w-full">
          </div>
          <button id="fav-btn" class="w-full bg-[#ff4444] hover:bg-red-600 text-white py-2 rounded font-bold">
            <i class="fa fa-heart"></i> Add to Favourites
          </button>
        </div>
      </div>

      <!-- Details -->
      <div class="flex-grow space-y-4">
        <div>
          <h1 id="anime-title" class="text-3xl font-bold text-[#ff4444]"></h1>
          <p id="anime-alt-titles" class="text-sm text-gray-400 italic"></p>
        </div>
        <p id="anime-synopsis" class="text-gray-300 leading-relaxed"></p>

        <!-- Genres -->
        <div id="anime-genres" class="flex flex-wrap gap-2"></div>

        <!-- Info Grid -->
        <div class="grid grid-cols-2 gap-y-1 text-sm text-gray-300">
          <span class="font-semibold">Format:</span> <span id="anime-format"></span>
          <span class="font-semibold">Status:</span> <span id="anime-status"></span>
          <span class="font-semibold">Episodes:</span> <span id="anime-episodes"></span>
          <span class="font-semibold">Rating:</span> <span id="anime-rating"></span>
        </div>

        <!-- Watch Buttons -->
        <div class="flex gap-4 mt-4">
          <a id="btn-raw" href="#" class="px-4 py-2 rounded bg-yellow-500 hover:bg-yellow-600 text-black font-bold transition">RAW</a>
          <a id="btn-sub" href="#" class="px-4 py-2 rounded bg-green-500 hover:bg-green-600 text-black font-bold transition">SUB</a>
          <a id="btn-dub" href="#" class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-black font-bold transition">DUB</a>
        </div>
      </div>
    </section>

    <!-- Related Anime -->
    <section class="mt-10">
      <h2 class="section-title">Related Anime</h2>
      <div id="related-anime" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
    </section>

    <!-- Characters -->
    <section class="mt-10">
      <h2 class="section-title">Characters & Voice Actors</h2>
      <div id="characters-list" class="space-y-4"></div>
    </section>

    <!-- Staff -->
    <section class="mt-10">
      <h2 class="section-title">Staff</h2>
      <div id="staff-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
    </section>

  </main>

  <div id="footer"></div>

  <script>
    async function loadPartials() {
      const headerHTML = await fetch("header.html").then(res => res.text());
      document.getElementById("header").innerHTML = headerHTML;
      const footerHTML = await fetch("footer.html").then(res => res.text());
      document.getElementById("footer").innerHTML = footerHTML;
      setupMobileMenuToggle();
      await initAnimePage();
    }

    function setupMobileMenuToggle() {
      const btn = document.getElementById("menu-btn");
      const menu = document.getElementById("mobile-menu");
      if (btn && menu) btn.addEventListener("click", () => menu.classList.toggle("hidden"));
    }

    function getAnimeIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    async function fetchAnimeDetails(id) {
      const query = `
        query ($id: Int) {
          Media(id: $id, type: ANIME) {
            id
            title { romaji english native }
            coverImage { large }
            description
            genres
            format
            status
            episodes
            averageScore
            relations {
              edges {
                relationType(version: 2)
                node { id title { romaji english } coverImage { medium } }
              }
            }
            characters(sort: ROLE) {
              edges {
                role
                node { id name { full } image { medium } }
                voiceActors(language: JAPANESE) { id name { full } language image { medium } }
              }
            }
            staff(sort: RELEVANCE) {
              edges {
                role
                node { id name { full } image { medium } }
              }
            }
          }
        }
      `;
      const res = await fetch("https://graphql.anilist.co", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, variables: { id } })
      });
      const data = await res.json();
      return data.data.Media;
    }

    async function checkJsonAvailability(id) {
      try {
        const res = await fetch("episodes.json");
        const json = await res.json();
        return json[id] || null;
      } catch { return null; }
    }

    async function initAnimePage() {
      const animeId = getAnimeIdFromURL();
      if (!animeId) return;

      const anime = await fetchAnimeDetails(animeId);

      // Main info
      document.getElementById("anime-poster").src = anime.coverImage.large;
      document.getElementById("anime-title").textContent = anime.title.english || anime.title.romaji;
      document.getElementById("anime-alt-titles").textContent = `${anime.title.romaji} | ${anime.title.native || ''}`;
      document.getElementById("anime-synopsis").innerHTML = anime.description || "No description available.";
      document.getElementById("anime-format").textContent = anime.format || "N/A";
      document.getElementById("anime-status").textContent = anime.status || "N/A";
      document.getElementById("anime-episodes").textContent = anime.episodes || "N/A";
      document.getElementById("anime-rating").textContent = anime.averageScore ? `${anime.averageScore}/100` : "N/A";

      // Genres
      const genresContainer = document.getElementById("anime-genres");
      anime.genres.forEach(genre => {
        const g = document.createElement("a");
        g.href = `search.html?genre=${encodeURIComponent(genre)}`;
        g.textContent = genre;
        g.className = "genre-tag";
        genresContainer.appendChild(g);
      });

      // Watch Buttons
      const availability = await checkJsonAvailability(animeId);
      const btnRaw = document.getElementById("btn-raw");
      const btnSub = document.getElementById("btn-sub");
      const btnDub = document.getElementById("btn-dub");
      btnRaw.href = `/watch.html?id=${animeId}&type=raw`;
      btnSub.href = `/watch.html?id=${animeId}&type=sub`;
      btnDub.href = `/watch.html?id=${animeId}&type=dub`;
      if (!availability) { btnRaw.classList.add("inactive-btn"); btnSub.classList.add("inactive-btn"); btnDub.classList.add("inactive-btn"); }
      else {
        if (!availability.types.includes("raw")) btnRaw.classList.add("inactive-btn");
        if (!availability.types.includes("sub")) btnSub.classList.add("inactive-btn");
        if (!availability.types.includes("dub")) btnDub.classList.add("inactive-btn");
      }

      // Related Anime
      const relatedContainer = document.getElementById("related-anime");
      anime.relations.edges.forEach(r => {
        const card = document.createElement("a");
        card.href = `anime.html?id=${r.node.id}`;
        card.className = "block bg-black/50 rounded shadow hover:shadow-[#ff4444] transition";
        card.innerHTML = `<img src="${r.node.coverImage.medium}" class="w-full rounded-t" />
                          <div class="p-1 text-xs text-center">${r.node.title.english || r.node.title.romaji}</div>`;
        relatedContainer.appendChild(card);
      });

      // Characters
      const charContainer = document.getElementById("characters-list");
      anime.characters.edges.forEach(c => {
        const charDiv = document.createElement("div");
        charDiv.className = "flex items-center bg-black/40 rounded p-2";
        charDiv.innerHTML = `
          <a href="character.html?id=${c.node.id}" class="flex items-center gap-2 w-1/2">
            <img src="${c.node.image.medium}" class="w-12 h-12 rounded object-cover" />
            <div>
              <div class="font-semibold">${c.node.name.full}</div>
              <div class="text-xs text-gray-400">${c.role}</div>
            </div>
          </a>
          ${c.voiceActors[0] ? `
          <a href="staff.html?id=${c.voiceActors[0].id}" class="flex items-center gap-2 w-1/2 justify-end">
            <div class="text-right">
              <div class="font-semibold">${c.voiceActors[0].name.full}</div>
              <div class="text-xs text-gray-400">${c.voiceActors[0].language}</div>
            </div>
            <img src="${c.voiceActors[0].image.medium}" class="w-12 h-12 rounded object-cover" />
          </a>` : ''}
        `;
        charContainer.appendChild(charDiv);
      });

      // Staff
      const staffContainer = document.getElementById("staff-list");
      anime.staff.edges.forEach(s => {
        const card = document.createElement("a");
        card.href = `staff.html?id=${s.node.id}`;
        card.className = "bg-black/40 rounded p-2 flex flex-col items-center text-center";
        card.innerHTML = `
          <img src="${s.node.image.medium}" class="w-20 h-20 rounded-full object-cover mb-2" />
          <div class="font-semibold">${s.node.name.full}</div>
          <div class="text-xs text-gray-400">${s.role}</div>
        `;
        staffContainer.appendChild(card);
      });
    }

    loadPartials();
  </script>
</body>
</html>
